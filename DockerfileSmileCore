ARG PHP_VERSION

FROM unicaen-dev-php${PHP_VERSION}-apache

#Add proxy
ENV HTTP_PROXY http://proxy.unicaen.fr:3128
ENV HTTPS_PROXY http://proxy.unicaen.fr:3128
RUN export http_proxy=$HTTP_PROXY
RUN export https_proxy=$HTTPS_PROXY
RUN touch /etc/apt/apt.conf.d/05proxy
RUN echo 'Acquire::HTTP::Proxy "http://proxy.unicaen.fr:3128";' >> /etc/apt/apt.conf.d/05proxy
RUN echo 'Acquire::HTTPS::Proxy "http://proxy.unicaen.fr:3128";' >> /etc/apt/apt.conf.d/05proxy
RUN echo 'Acquire::ftp::Proxy "http://proxy.unicaen.fr:3128";' >> /etc/apt/apt.conf.d/05proxy


LABEL maintainer="Thibaut VALLEE <thibaut.vallee at unicaen.fr>"

COPY . /var/www/html

WORKDIR /var/www/html

ENV APACHE_CONF_DIR=/etc/apache2 \
    PHP_CONF_DIR=/etc/php/${PHP_VERSION}


## Installation de packages requis.
RUN apt-get update -qq && \
    apt-get install -y \
        php${PHP_VERSION}-pgsql

# Nettoyage
RUN apt-get autoremove -y && apt-get clean && rm -rf /tmp/* /var/tmp/*

RUN apt-get install -y php${PHP_VERSION}-xml php${PHP_VERSION}-intl php${PHP_VERSION}-ldap php${PHP_VERSION}-bcmath php${PHP_VERSION}-pgsql

# Symlink apache access and error logs to stdout/stderr so Docker logs shows them
RUN ln -sf /dev/stdout /var/log/apache2/access.log
RUN ln -sf /dev/stdout /var/log/apache2/other_vhosts_access.log
RUN ln -sf /dev/stderr /var/log/apache2/error.log

# Configuration Apache et FPM
ADD docker/apache/000-default.conf ${APACHE_CONF_DIR}/sites-available/
ADD docker/php/fpm/conf.d/*.ini ${PHP_CONF_DIR}/fpm/conf.d/
ADD docker/php/cli/conf.d/*.ini ${PHP_CONF_DIR}/cli/conf.d/

RUN apt-get update
RUN apt-get install -y composer
RUN composer install --no-dev --no-suggest --optimize-autoloader 
#Fix bug unicaen auth
RUN composer require unicaen/auth "6.0.1"

# mpdf/mpdf/ttfontdata dir access
#chown -R www-data:root vendor/mpdf/mpdf/ttfontdata && chmod -R 770 vendor/mpdf/mpdf/ttfontdata

# Répertoire d'upload par défaut
#mkdir -p upload && chown -R www-data:root upload && chmod -R 770 upload

# Répertoires de travail de Doctrine
RUN mkdir -p data/cache                   && chmod -R 777 data/cache
RUN mkdir -p data/DoctrineModule/cache    && chmod -R 777 data/DoctrineModule/cache
RUN mkdir -p data/DoctrineORMModule/Proxy && chmod -R 777 data/DoctrineORMModule/Proxy
RUN rm -rf data/cache/*
RUN rm -rf data/DoctrineModule/cache/*
RUN rm -rf data/DoctrineORMModule/Proxy/*


# Commandes Doctrine removed fix RA
#RUN vendor/bin/doctrine-module orm:clear-cache:query
#RUN vendor/bin/doctrine-module orm:clear-cache:metadata
#RUN vendor/bin/doctrine-module orm:clear-cache:result
#RUN vendor/bin/doctrine-module orm:generate-proxies

RUN service apache2 restart

RUN a2enconf php${PHP_VERSION}-fpm.conf && \
    service php${PHP_VERSION}-fpm reload

ENV HTTP_PROXY ""
ENV HTTPS_PROXY ""
RUN export http_proxy=""
RUN export https_proxy=""
RUN rm /etc/apt/apt.conf.d/05proxy
